{% extends "base.html" %}

{% block title %}Chat RAG{% endblock %}

{% block extra_head %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    min-height: 600px;
}

.chat-messages {
    height: 70%;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: #f8f9fa;
    margin-bottom: 1rem;
}

.message {
    margin-bottom: 1rem;
    padding: 0.75rem;
    border-radius: 0.375rem;
    max-width: 85%;
}

.message.user {
    background-color: #007bff;
    color: white;
    margin-left: auto;
    text-align: right;
}

.message.assistant {
    background-color: white;
    border: 1px solid #dee2e6;
    margin-right: auto;
}

.message-header {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.message-content {
    line-height: 1.5;
}

.sources {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #dee2e6;
}

.source-item {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.source-score {
    font-weight: 600;
    color: #28a745;
}

.source-title {
    font-weight: 600;
    color: #495057;
}

.source-text {
    color: #6c757d;
    margin-top: 0.25rem;
    font-style: italic;
}

.chat-input-section {
    height: 25%;
    display: flex;
    flex-direction: column;
}

.settings-panel {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.loading {
    text-align: center;
    color: #6c757d;
    font-style: italic;
    padding: 1rem;
}

.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    border-radius: 0.375rem;
    padding: 0.75rem;
    margin-bottom: 1rem;
}

.metrics {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

#queryInput {
    resize: vertical;
    min-height: 80px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h2><i class="fa-solid fa-comments me-2"></i>Chat RAG</h2>
            <p class="text-muted">Consulta tu conocimiento institucional mediante búsqueda semántica</p>
        </div>
    </div>

    <div class="row">
        <!-- Panel de configuración -->
        <div class="col-md-3">
            <div class="settings-panel">
                <h5><i class="fa-solid fa-sliders me-2"></i>Configuración</h5>
                
                <div class="mb-3">
                    <label for="storeSelect" class="form-label">Vector Store</label>
                    <select class="form-select" id="storeSelect">
                        <option value="chroma">ChromaDB</option>
                        <option value="faiss">FAISS</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="collectionSelect" class="form-label">Colección</label>
                    <select class="form-select" id="collectionSelect">
                        <option value="">Cargando...</option>
                    </select>
                </div>
                <div id="rag-endpoints" data-collections="{{ url_for('admin_rag.list_collections') }}"></div>
                <script src="{{ url_for('static', filename='js/admin_rag_collections.js') }}" defer></script>
                <div id="rag-endpoints"
     data-collections="{{ url_for('admin_rag.list_collections') }}"
     data-query="{{ url_for('admin_rag.rag_query') }}"></div>

<script src="{{ url_for('static', filename='js/admin_rag_collections.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/admin_rag_query.js') }}" defer></script>


                <div class="mb-3">
                    <label for="kSelect" class="form-label">Resultados (k)</label>
                    <select class="form-select" id="kSelect">
                        <option value="3">3</option>
                        <option value="5" selected>5</option>
                        <option value="10">10</option>
                        <option value="15">15</option>
                    </select>
                </div>

                <div class="mb-3">
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshCollections">
                        <i class="fa-solid fa-sync"></i> Actualizar
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" id="clearChat">
                        <i class="fa-solid fa-trash"></i> Limpiar
                    </button>
                </div>

                <!-- Info de la colección -->
                <div id="collectionInfo" class="mt-3" style="display: none;">
                    <h6>Información:</h6>
                    <div class="small text-muted" id="collectionDetails"></div>
                </div>
            </div>
        </div>

        <!-- Chat principal -->
        <div class="col-md-9">
            <div class="chat-container">
                <!-- Mensajes -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-header">
                            <i class="fa-solid fa-robot me-2"></i>Sistema RAG
                        </div>
                        <div class="message-content">
                            ¡Hola! Soy tu asistente de conocimiento institucional. 
                            Selecciona una colección y hazme cualquier pregunta sobre documentos administrativos.
                        </div>
                    </div>
                </div>

                <!-- Input de consulta -->
                <div class="chat-input-section">
                    <div class="input-group">
                        <textarea 
                            class="form-control" 
                            id="queryInput" 
                            placeholder="Escribe tu consulta aquí... (Ej: ¿Qué documentos necesito para una licencia de obra?)"
                            rows="3"></textarea>
                        <button class="btn btn-primary" type="button" id="sendBtn">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
(function initAdminRag() {
  const start = async () => {
    console.log('[RAG] init');

    const select = document.getElementById('collectionSelect');
    const refreshBtn = document.getElementById('refreshCollections');
    const chatMessages = document.getElementById('chatMessages');

    const addMsg = (html) => {
      const div = document.createElement('div');
      div.className = 'message assistant';
      div.innerHTML = `<div class="message-content">${html}</div>`;
      chatMessages.appendChild(div);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    async function loadCollections() {
      try {
        const resp = await fetch('/admin/rag/collections', { credentials: 'include' });
        if (!resp.ok) {
          addMsg(`Error colecciones (HTTP ${resp.status})`);
          select.innerHTML = '<option value="">Error</option>';
          return;
        }
        const ct = resp.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          addMsg('Respuesta no-JSON (¿login?)');
          select.innerHTML = '<option value="">Login requerido</option>';
          return;
        }
        const data = await resp.json();
        console.log('[RAG] collections:', data);

        const cols = data.collections || [];
        select.innerHTML = '';
        if (cols.length === 0) {
          select.innerHTML = '<option value="">No hay colecciones</option>';
        } else {
          cols.forEach(col => {
            const opt = document.createElement('option');
            opt.value = `${col.store}:${col.name}`;
            opt.textContent = `${col.name} (${col.chunks ?? '?' } chunks)`;
            select.appendChild(opt);
          });
          addMsg(`Colecciones cargadas: ${cols.length}`);
        }
      } catch (e) {
        console.error('[RAG] loadCollections error:', e);
        select.innerHTML = '<option value="">Error</option>';
        addMsg('Error cargando colecciones');
      }
    }

    refreshBtn?.addEventListener('click', loadCollections);
    await loadCollections(); // primera carga
  };

  // Arranque seguro: si ya cargó el DOM, ejecuta; si no, espera al evento
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start, { once: true });
  } else {
    start();
  }
})();
</script>   
{% endblock %}